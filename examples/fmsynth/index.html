<!doctype html>
<html>

<head>
  <title>Examples | MOTW 2015</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
  <link rel="import" href="../../assets/example-common.html"></script>

  <link rel="import" href="spiral-envelope/spiral-envelope.html"></script>
</head>

<body>
  <div class="example-header">
    <div class="subheading-1"><a href="../">Example</a> :</div>
    <div class="heading-1">FM Synthesis</div>
    <p class="example-header-desc">
      FM Synthesis: <i>The Synthesis of Complex Audio Spectra by Means of 
      Frequency Modulation</i> by John M. Chowning.
    </p>
  </div>

  <div class="example-main">
    <spiral-envelope id="env1"></spiral-envelope>
    <br><br>
    <div class="parameter">
      <span class="label">Duration</span>
      <input type="range" id="dur" min="0.2" value="1" max="20" step="0.1">
      <span class="value" id="dur-value">1 sec.</span>
    </div>
    <div class="parameter">
      <span class="label">Harmonic Ratio (c/m)</span>
      <input type="range" id="harmrat" min="1" value="1" max="10" step="0.5">
      <span class="value" id="harmrat-value">1</span>
    </div>
    <div class="parameter">
      <span class="label">Modulation Index 1</span>
      <input type="range" id="mi1" min="1" value="1" max="10" step="0.5">
      <span class="value" id="mi1-value">1</span>
    </div>
    <div class="parameter">
      <span class="label">Modulation Index 2</span>
      <input type="range" id="mi2" min="1" value="1" max="10" step="0.5">
      <span class="value" id="mi2-value">1</span>
    </div>
  </div>

  <script>
    var context = new AudioContext();

    // http://web.eecs.umich.edu/~fessler/course/100/misc/chowning-73-tso.pdf
    function FMCircuit(ctx) {
      this.context = ctx;
      this.car = ctx.createOscillator();
      this.mod = ctx.createOscillator();
      this.amp = ctx.createGain();
      this.modAmp = ctx.createGain();

      this.mod.connect(this.modAmp);
      this.modAmp.connect(this.car.frequency);
      this.car.connect(this.amp);
      this.amp.connect(ctx.destination);
    }

    // p3, p4, p5, p6, p7, p8
    FMCircuit.prototype.noteOn = function (dur, amp, cf, mf, mi1, mi2, env) {
      this.car.frequency.value = cf;
      this.mod.frequency.value = mf;

      var dev1 = mi1 * mf;
      var dev2 = (mi2 - mi1) * mf;
      var now = this.context.currentTime;

      for (var i = 0; i < env.length; i++) {
        var scale = env[i][0];
        var time = now + dur * env[i][1];
        if (i === 0) {
          this.modAmp.gain.setValueAtTime(dev1 + dev2 * scale, time);
          this.amp.gain.setValueAtTime(amp * scale, time);
        } else {
          this.modAmp.gain.linearRampToValueAtTime(dev1 + dev2 * scale, time);
          this.amp.gain.linearRampToValueAtTime(amp * scale, time);
        }
      }

      this.car.start(now);
      this.car.stop(now + dur);
      this.mod.start(now);
      this.mod.stop(now + dur);
    };

    // value, time pairs.
    var brassEnvelope = [
      [0.0, 0.0],
      [1.0, 0.16],
      [0.75, 0.33],
      [0.55, 0.83],
      [0.0, 1.0]
    ];

    var woodwindEnvelope = [
      [0.0, 0.0],
      [1.0, 0.2],
      [1.0, 0.9],
      [0.0, 1.0]
    ];

    var percussiveEnvelope = [
      [0.0, 0.0],
      [1.0, 0.25],
      [0.0, 1.0]
    ];


    var env1 = document.getElementById('env1');

    var durval = 1;
    var harmrat = 1;
    var mi1val = 1;
    var mi2val = 1;

    window.addEventListener('keydown', function () {
      var voice = new FMCircuit(context);

      // Brass-like.
      // voice.noteOn(0.6, 1.0, 440, 440, 0, 5, brassEnvelope);
      
      // Woodwinds.
      // voice.noteOn(0.5, 1.0, 900, 300, 0, 2, woodwindEnvelope);
      // voice.noteOn(0.5, 1.0, 500, 100, 0, 1.5, woodwindEnvelope);
      // voice.noteOn(0.5, 1.0, 900, 600, 4, 2, woodwindEnvelope);
      
      // Percussive.
      // voice.noteOn(0.2, 1.0, 200, 280, 0, 2, percussiveEnvelope);
      // voice.noteOn(0.2, 1.0, 80, 55, 0, 25, percussiveEnvelope);

      // Arbitrary.
      voice.noteOn(durval, 1.0, 440, 440 / harmrat, mi1val, mi2val, env1.getEnvelope());

      // Extra
      // mi1 slider
      // mi2 slider
    });

    

    // handle slider-input event.
    
    var durSlider = document.getElementById('dur');
    var durLabel = document.getElementById('dur-value');

    durSlider.oninput = function (event) {
      durLabel.textContent = event.target.value + ' sec.';
      durval = Number(event.target.value);
    }

    var harmratSlider = document.getElementById('harmrat');
    var harmratLabel = document.getElementById('harmrat-value');

    harmratSlider.oninput = function (event) {
      harmratLabel.textContent = event.target.value;
      harmrat = event.target.value;
    }

    var mi1Slider = document.getElementById('mi1');
    var mi1Label = document.getElementById('mi1-value');

    mi1Slider.oninput = function (event) {
      mi1Label.textContent = event.target.value;
      mi1val = event.target.value;
    }

    var mi2Slider = document.getElementById('mi2');
    var mi2Label = document.getElementById('mi2-value');

    mi2Slider.oninput = function (event) {
      mi2Label.textContent = event.target.value;
      mi2val = event.target.value;
    }

  </script>
</body>

</html>